# cumulus-sns-schema

The cumulus SNS schema is used to interface providers with cumulus/AWS ingestion pipelines. It can be thought of as a stripped down version of the PDR/PAN interface for ingestion within the AWS environment (i.e. S3 staged products).

## Overview

![Alt text](resources/images/SNS_overview.png?raw=true "overview")


## Notification Messages

The current schema can specify a bucket or bucket+granule single granule ingest. Multiple granules within a specified bucket are not supported at this time, as bundling granules together would encumber the scalability of which we hope to take advantage.

Each message needs to have a unique identifier, generated by the sender of the initial message. All subsequent messages relating to this product will use the identifier for provenance.

For sending an initial message, the following fields are required:

| Field     | Required     | description |
| :------------- | :------------- | :------------- |
| collection       | True       | The name of the collection being notified for ingest       |
| deliveryTime       | True       | The time the message was sent to the ingest system       |
| identifier       | True       | A SIPS generated identifier for this message transaction        |
| bucket       | True       | The S3 bucket from which ingestion will be done       |
| granule       | False       | See the granule object in the cumulus_sns_schema.json filefor more information.     |

## Response Messages

Response messages combine the ideas of PAN and PDRD, meaning a single message can be sent in case of parse error or in case of ingestion error.

| Field     | Required     | description |
| :------------- | :------------- | :------------- |
| collection       | True       | The name of the collection being notified for ingest       |
| deliveryTime       | True       | The time the message was sent to the ingest system       |
| ingestTime       | True       | The time the message was processed for ingest by the ingest system       |
| identifier       | True       | The SIPS generated identifier for this message transaction        |
| response       | True       | See the response object in the cumulus_sns_schema.json filefor more information.       |

##### Parse error:

```
{
  "provider": "PODAAC_SWOT",
  "collection": "SWOT_Prod_l2:1",
  "ingestTime":"2017-09-30T03:45:29.791198",
  "deliveryTime":"2017-09-30T03:42:29.791198",
  "identifier": "1234-abcd-efg0-9876",
  "response": {
    "status":"FAILURE",
    "errorCode": "UNKNOWN_ERROR",
    "errorMessage": "An unknown error occured while parsing the received message: {\"collection\":\"SWOT_Prod_l2:1\" .... } >."
  }
}
```
##### Ingestion Error

```
{
  "provider": "PODAAC_SWOT",
  "collection": "SWOT_Prod_l2:1",
  "ingestTime":"2017-09-30T03:45:29.791198",
  "deliveryTime":"2017-09-30T03:42:29.791198",
  "identifier": "1234-abcd-efg0-9876",
  "response": {
    "status":"FAILURE",
    "errorCode": "INGEST_ERROR",
    "errorMessage": "File [cumulus-dev-a4d38f59-5e57-590c-a2be-58640db02d91/prod_20170926T11:30:36/production_file.nc] did not match gve checksum value."
  }
}
```
